---
title: "Onikiri2ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦è©¦ã™"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["cpu", "risc-v"]
published: true
---

[Onikiri2](https://github.com/onikiri/onikiri2) ã¨ã„ã†ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã™ã€‚
ã“ã®ãƒ—ãƒ­ã‚»ãƒƒã‚µã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã‚’è§¦ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸãŸã‚ã€ãƒ“ãƒ«ãƒ‰ã‹ã‚‰å‹•ä½œç¢ºèªã¾ã§ã®æ‰‹é †ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã¨ã¯è¨€ã£ã¦ã‚‚ã€åŸºæœ¬çš„ã«ã¯ README.md ã‚„ [Wiki](https://www.mtl.t.u-tokyo.ac.jp/~onikiri2/wiki/index.php?%E4%BB%95%E6%A7%98/%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88/%E3%83%93%E3%83%AB%E3%83%89) ã«å¾“ã†ã ã‘ã§ã™ã€‚

## ãƒ“ãƒ«ãƒ‰ï¼ˆLinuxã‚’ä»®å®šï¼‰

```bash
git clone git@github.com:onikiri/onikiri2.git --recursive
cd onikiri2
```

`project/gcc/onikiri2` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ `Makefile` ãŒç½®ã„ã¦ã‚ã‚‹ã®ã§ã™ãŒã€ã“ã®ä¸­ã® `CXXFLAGS` ã« `-Wno-deprecated-declarations` ã‚’è¿½åŠ ã—ã¾ã™ã€‚
ã“ã‚Œã¯ã€ã‚³ãƒ¼ãƒ‰ä¸­ã§ deprecated ãª `std::unary_function` ãŒä½¿ã‚ã‚Œã¦ãŠã‚Šã€æ–°ã—ã„ g++ï¼ˆæ‰‹å…ƒã¯ 13.2.0ï¼‰ã ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ãŸã‚ã§ã™ã€‚

```diff
...
# Platform: linux
ifneq (,$(findstring Linux,$(HOST_TYPE)))
WORK_DIR = WorkLinux/
CXX = g++
- CXXFLAGS = -Wall -Werror -O2 -g -std=c++11 -DONIKIRI_DEBUG \
+ CXXFLAGS = -Wall -Werror -O2 -g -std=c++11 -DONIKIRI_DEBUG -Wno-deprecated-declarations \
        -I../../../src \
        -I../../../src/pch \
...
```

ã‚ã¨ã¯ `make` ã™ã‚‹ã ã‘ã§ã™ã€‚`project/gcc/onikiri2/a.out` ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚

```bash
(cd project/gcc && make -j$(nproc))
```

## å‹•ä½œç¢ºèª

`benchmark/HelloWorld` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ "hello, world" ã‚’å‡ºåŠ›ã™ã‚‹ãŸã‚ã® `main.c` ãŠã‚ˆã³ `param.xml` ãŒç½®ã„ã¦ã‚ã‚Šã¾ã™ã€‚
ã©ã†ã‚„ã‚‰ã€onikiri2 ã®ãƒã‚¤ãƒŠãƒªã« `param.xml` ã‚’æ¸¡ã™ã“ã¨ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

ã¾ãŸã€`main.c` ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã¯ `riscv64-unknown-linux-gnu-gcc` ã§è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ãƒ‘ã‚¹ãŒé€šã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

```bash
(cd benchmark/HelloWorld && make && ../../project/gcc/onikiri2/a.out param.xml)
```

ã“ã‚Œã§ "hello, world" ã§ãã‚‹ã¯ãšãªã®ã§ã™ãŒã€RISC-V ã® GCCï¼ˆã‹ glibcï¼‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå½“åˆã¨ç•°ãªã‚‹ã›ã„ã‹ unknown syscall ã¨è¨€ã‚ã‚Œã¦ã—ã¾ã„ã¾ã—ãŸã€‚

ã²ã¨ã¾ãš `src/Emu/RISCV64Linux/RISCV64LinuxSyscallConv.cpp` ã«ä¸è¶³ã—ã¦ã„ãŸ syscall (99, 278) ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§å¯¾å‡¦ã—ã¾ã—ãŸã€‚

```bash
# ../../project/gcc/onikiri2/a.out param.xml
Onikiri Version 2.9000
Emulator ... initialized.
Resources ... initialized.
214 brk(0x0) = 89678
214 brk(0x8a170) = 8a170
96 set_tid_address(0x89750) = 3e8
99  = error 0
261 prlimit64(0, 3, 0x0, 0x7ffffffffeb0) = 0
78 readlinkat(-100, 0x64540="/proc/self/exe", 0x7fffffffee20="", 4096) = 0
278  = error 0
113 clock_gettime(1, 0x7ffffffffdb0) = 0
113 clock_gettime(1, 0x7ffffffffdb0) = 0
214 brk(0x0) = 8a170
214 brk(0xab170) = ab170
214 brk(0xac000) = ac000
226 mprotect(0x7f000, 0x3000, 0x1) = 0
79 fstatat(1, 0x64028="", 0x7ffffffffc40, 4096) = 0
64 write(1, 0x8a530, 13)hello, world
 = d
94 exit_group() = error 0
```

ãã¡ã‚“ã¨ "hello, world" ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã¾ã™ã­ã€‚
