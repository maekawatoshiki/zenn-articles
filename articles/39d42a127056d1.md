---
title: "LLVMのレジスタアロケータについてまとめた"
emoji: "🐉"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["llvm", "compiler"]
published: false
---

# この記事は何？

[LLVM](https://llvm.org/) には当然ながらレジスタアロケータが実装されています。
初見ではなかなか動作が追いにくいため、備忘録を兼ねて記事を書くことにしました。

# LLVMのレジスタアロケータの特徴

コンパイラの教科書を読んでいると、レジスタアロケーションのためにグラフ彩色問題を解いていることが多いです。これ自体は特におかしなことではありません。

一方、LLVMのレジスタアロケータはグラフ彩色問題を解きません。理由は様々ありますが、以下に要約されます。[^1]
- グラフを構築するのは時間がかかる
- グラフ彩色よりも、スピルのためのコードをどう配置するかが重要
- エイリアスや重なり合ったレジスタクラス（e.g. `eax`と`rax`）をうまく扱わないといけない
- グラフ彩色よりも、（アロケータを）柔軟にいじれることが重要

LLVM には `Basic`, `Fast`, `Greedy`, `PBQP` の4種類のアロケータが実装されており、特徴は以下の通りです。

- `Basic`: レジスタアロケータとしての最小限の実装
- `Fast`: 基本ブロック単位でレジスタを割り当てる（ので速い）
- `Greedy`: 複雑なレジスタアロケーションを行う（ので最適化ビルド向け）
- `PBQP`: Partitioned Boolean Quadratic Programming に基づくレジスタアロケーションを行う（この記事ではあまり触れません）

この記事では、`Basic` と `Greedy` に特に焦点をあてて解説します。

# LLVMのレジスタアロケータの構造

ここからは、[`llvm/lib/Codegen`](https://github.com/llvm/llvm-project/tree/main/llvm/lib/CodeGen) 下のソースコードを参照します。特に `RegAlloc*.(cpp|h)` という名前のファイルが重要です。

また、LLVM IR は SSA 形式ですが、レジスタアロケータが動作する段階まで来るともはや SSA ではありません。つまり、値が複数の場所で定義されることがあります。

## 準備

### `RegAllocBase` クラス

[`RegAllocBase.h`](https://github.com/llvm/llvm-project/blob/26c95ae38940b5b6ccfc65188ba9931eb51e468e/llvm/lib/CodeGen/RegAllocBase.h#L61) に定義されており、すべてのレジスタアロケータはこのクラスから派生します。特に、すべてのレジスタアロケータは `selectOrSplit` メソッドをオーバーライドしなければなりません。このメソッドについては後述します。

### `LiveRange` クラス

[`LiveInterval.h`](https://github.com/llvm/llvm-project/blob/112aafcaf425dca901690ca823d25607e5795263/llvm/include/llvm/CodeGen/LiveInterval.h#L157)に定義されており、あるレジスタやスタックスロットの生存区間を表現します。
そもそも生存区間が何なのかは、以下の画像を見ればわかると思います。

<!-- ある値が定義されてから最後に使われるまで -->

基本ブロックを一列に並べたとき、ある値が定義されてから最後に使われるまでが生存区間です。
このとき、制御フローによっては生存区間が複数に分割されることがあります。（画像では `%a` が該当）

![live range](/images/liverange.png)


# 参考

- [LLVM Register Allocation](https://www.slideshare.net/chimerawang/llvm-register-allocation-59885569)
- [Greedy Register Allocation in LLVM 3.0](https://blog.llvm.org/2011/09/greedy-register-allocation-in-llvm-30.html)
- [Register Allocation in LLVM 3.0](https://llvm.org/devmtg/2011-11/Olesen_RegisterAllocation.pdf)

[^1]: [Register Allocation in LLVM 3.0](https://llvm.org/devmtg/2011-11/Olesen_RegisterAllocation.pdf), p.7
