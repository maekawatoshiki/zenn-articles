---
title: "ONNX ã«ã¤ã„ã¦"
emoji: "ğŸª¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ONNX"]
published: true
---

# ã¯ã˜ã‚ã«

> **ONNX is an open format built to represent machine learning models.**
>
> ONNX defines a common set of operators -
> the building blocks of machine learning and deep learning models -
> and a common file format to enable AI developers to use models with
> a variety of frameworks, tools, runtimes, and compilers.
>
> *[onnx.ai](https://onnx.ai/) ã‚ˆã‚Š*

[ONNX](https://github.com/onnx/onnx) ã¨ã¯ã€æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚„å‘¨è¾ºã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ï¼‰ã‚’æŒ‡ã—ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã‚ã¾ã‚Šæ—¥æœ¬èªã®è³‡æ–™ãŒè¦‹ã¤ã‹ã‚‰ãªã„éƒ¨åˆ†ã€ç‰¹ã« **ONNX ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ§‹é€ ã‚„ä¸Šæ‰‹ãªæ‰±ã„æ–¹**ã«ã¤ã„ã¦è§¦ã‚Œã¦ã„ãã¾ã™ã€‚

ãªãŠã€å¿…ãšã—ã‚‚æ­£ç¢ºãªæƒ…å ±ã‚’æä¾›ã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ãŸã‚ã€é–“é•ã„ãªã©ã¯ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ã„ãŸã ã‘ã‚‹ã¨åŠ©ã‹ã‚Šã¾ã™ã€‚

# ä¾¿åˆ©ãªãƒªãƒ³ã‚¯é›†

- https://onnx.ai
    - å…¬å¼ã‚µã‚¤ãƒˆ
    - å„ç¨®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸é£›ã¶ãŸã‚ã®ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã¨ã—ã¦ã‚‚æ©Ÿèƒ½ã—ã¦ã„ã‚‹
- https://github.com/onnx/onnx
    - å…¬å¼ GitHub ãƒªãƒã‚¸ãƒˆãƒª
    - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å®šç¾©ã‚„å‘¨è¾ºãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ãƒ„ãƒ¼ãƒ«ãªã©ã‚’ç®¡ç†ã—ã¦ã„ã‚‹
- https://github.com/onnx/onnx/blob/main/docs/
    - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
    - å›°ã£ãŸã‚‰ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã‚’æ¢ã™
- https://github.com/onnx/onnx/blob/main/docs/IR.md
    - IR (ä¸­é–“è¡¨ç¾ï¼‰ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- https://github.com/onnx/onnx/blob/main/docs/Operators.md
    - ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆä¸€è¦§ï¼‰
- https://github.com/onnx/models
    - ONNX å½¢å¼ã®å­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ãŒå¤šæ•°ç½®ã„ã¦ã‚ã‚‹ãƒªãƒã‚¸ãƒˆãƒª
    - PyTorch ãªã©ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ä»–ã«ã“ã†ã„ã£ãŸå ´æ‰€ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹
- https://github.com/PINTO0309/PINTO_model_zoo
    - å€‹äººã§è†¨å¤§ãªæ•°ã® ONNX å½¢å¼ãƒ¢ãƒ‡ãƒ«ã‚’ç®¡ç†ã•ã‚Œã¦ã„ã‚‹æ–¹ã®ãƒªãƒã‚¸ãƒˆãƒª
- https://github.com/onnx/onnx/blob/main/docs/PythonAPIOverview.md
    - Python å‘ã‘ API ã®ä½¿ã„æ–¹

# ONNX ã®æ§‹é€ 

ONNX ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆä»¥ä¸‹ ONNXï¼‰ã¯ã€[IR.md](https://github.com/onnx/onnx/blob/main/docs/IR.md) ã«ã‚‚ã‚ã‚‹ã‚ˆã†ã«ã€[Protocol Buffers ã¨ã—ã¦å®šç¾©](https://github.com/onnx/onnx/blob/main/onnx/onnx.proto)ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã¤ã¾ã‚Šã€`*.onnx` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‹ã‘ãŸã‚‰ã€Protocol Buffers ã¨ã—ã¦ãƒ‡ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã™ã‚Œã°ä¸­èº«ã‚’è¦—ãã“ã¨ãŒã§ãã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ã¾ãšã¯å¤§ã¾ã‹ãªæ§‹é€ ã‚’æŠŠæ¡ã—ã¦ã€ãã®å¾Œã«ç´°ã‹ã„éƒ¨åˆ†ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

## å…¨ä½“åƒ

ONNX ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªéšå±¤æ§‹é€ ã‹ã‚‰æˆã‚Šç«‹ã£ã¦ã„ã¾ã™ï¼ˆã„ãã¤ã‹çœã„ã¦ã„ã‚‹è¦ç´ ãŒã‚ã‚Šã¾ã™ï¼‰ã€‚

- Model ([`onnx.ModelProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L348)) - ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«è¦ç´ ï¼‰
    - Graph ([`onnx.GraphProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L447)) - è¨ˆç®—ã‚°ãƒ©ãƒ•
        - Node ([`onnx.NodeProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L204)) - è¨ˆç®—ãƒãƒ¼ãƒ‰

ã¾ãŸã€ã“ã‚Œã‚‰ã®è¦ç´ ã«å«ã¾ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦ä»¥ä¸‹ãŒå­˜åœ¨ã—ã¾ã™ï¼ˆå€‹äººçš„ã«é‡è¦ã ã¨åˆ¤æ–­ã—ãŸã‚‚ã®ã‚’æŠœç²‹ã—ã¦ã„ã¾ã™ï¼‰ã€‚

- Tensor ([`onnx.TensorProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L487)) - ãƒ†ãƒ³ã‚½ãƒ«ï¼ˆé‡ã¿ï¼‰ã®ãƒ‡ãƒ¼ã‚¿
- ValueInfo ([`onnx.ValueInfoProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L187)) - å€¤ã‚’èª¬æ˜ã™ã‚‹æƒ…å ±
- Attribute ([`onnx.AttributeProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L120)) - Node ã«æŒ‡å®šã•ã‚Œã‚‹æƒ…å ±

## è§£é‡ˆ

ONNX ã¯åŸºæœ¬çš„ã«ã€ãªã«ã‹å…¥åŠ›å€¤ã‚’å—ã‘å–ã£ã¦ã€ãªã«ã‹å‡ºåŠ›å€¤ã‚’è¿”ã™ã¨ã„ã†è¨ˆç®—ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¾ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚

ã“ã“ã§ã€**å…¥åŠ›å€¤**ï¼ˆã®é…åˆ—ï¼‰ã¯ **`model.graph.input`** (ã¤ã¾ã‚Š [`ModelProto model > GraphProto graph > ValueInfoProto[] input`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L467)) ã«å¯¾å¿œã—ã¾ã™ï¼ˆã“ã‚Œã¯ãƒ¢ãƒ‡ãƒ«ã®å®Ÿè¡Œæ™‚ã«æ¸¡ã•ã‚Œã‚‹å€¤ï¼‰ã€‚
åŒæ§˜ã«ã€**å‡ºåŠ›å€¤**ï¼ˆã®é…åˆ—ï¼‰ã¯ **`model.graph.output`** ã«å¯¾å¿œã—ã¾ã™ã€‚
ã¾ãŸã€é‡ã¿ãªã©ã®**å®šæ•°å€¤**ã¯ã—ã°ã—ã° **`model.graph.initializer`** ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ã“ã‚Œã‚‚å…¥åŠ›å€¤ã¨ã¿ãªã›ã¾ã™ï¼ˆã“ã‚Œã¯å®Ÿè¡Œå‰ã‹ã‚‰ç”¨æ„ã•ã‚Œã¦ã„ã‚‹å€¤ï¼‰ã€‚

ã“ã‚Œã‚‰ã®å…¥åŠ›å€¤ã‚’ **`model.graph.node`** (ã¤ã¾ã‚Š [`ModelProto model > GraphProto graph > NodeProto[] node`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L449)) ã§æŒ‡å®šã•ã‚ŒãŸè¨ˆç®—ã«å¾“ã£ã¦å‡¦ç†ã™ã‚‹ã“ã¨ã§ã€å‡ºåŠ›å€¤ã‚’å¾—ã¾ã™ã€‚

## Operator

[Node](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/docs/IR.md#nodes) ã«ã¯ `op_type`ï¼ˆæ–‡å­—åˆ—ï¼‰ã¨ã„ã†ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã€ã“ã“ã« [Operators](https://github.com/onnx/onnx/blob/main/docs/Operators.md) ã«ã¦ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹å‘½ä»¤ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€è¨ˆç®—ã®ç¨®é¡ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ã‚ã‚‹ operator ã¯ã‚ã‚‹ domain ã«å±ã™ã‚‹**ã¨ã„ã†å®šç¾©ã¨ãªã£ã¦ã„ã¦ã€ä¾‹ãˆã° [Operators](https://github.com/onnx/onnx/blob/main/docs/Operators.md) ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ operator ã¯ã»ã¨ã‚“ã©ãŒ `ai.onnx` ã¨ã„ã†ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å±ã—ã¦ã„ã¾ã™ã€‚ä»–ã«ã¯ `com.microsoft.experimental` ãªã©ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚

è‡ªã‚‰æ–°ãŸãªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿½åŠ ãƒ»ãã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å±ã™ã‚‹ operator ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ONNX ã®ä»•æ§˜ã‚’è¶…ãˆãŸè¨ˆç®—ã‚’å¯èƒ½ã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

## Operator versioning

TODO...

# ONNX ã®æ‰±ã„æ–¹

å®Ÿéš›ã« ONNX ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¦é–‹ç™ºã‚’è¡Œã†ä¸Šã§ã€ä¾¿åˆ©ãªè±†çŸ¥è­˜ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

## ãƒ¢ãƒ‡ãƒ«ã®å¯è¦–åŒ–

ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰ã¨ã—ã¦ [`netron`](https://github.com/lutzroeder/netron) ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãä¾¿åˆ©ã§ã™ã€‚

```bash
# netron /path/to/model.onnx
Serving '/path/to/model.onnx' at http://localhost:8080
```

![netron](/images/netron.png)

## ä¾¿åˆ©ãªã‚¹ãƒ‹ãƒšãƒƒãƒˆ

### ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿

PyPI ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ `onnx` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†ã“ã¨ã§ã€Protocol Buffers ã‚’ã‚ã¾ã‚Šæ„è­˜ã›ãšã«ã€ãƒ¢ãƒ‡ãƒ«ã‚’æ‰±ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

```python
import onnx # pip install onnx
model = onnx.load("/path/to/model.onnx") # ModelProto ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œã‚‹
```

### ãƒ¢ãƒ‡ãƒ«ã®æ›¸ãè¾¼ã¿

```python
import onnx
onnx.save(model, "/path/to/model.onnx")
```

### ãƒ¢ãƒ‡ãƒ«ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

```python
import onnx
try:
    onnx.checker.check_model(model)
except onnx.checker.ValidationError as e:
    print(f"Invalid: {e}")
else:
    print("Valid")
```

### ãƒ¢ãƒ‡ãƒ«ã® Shape æ¨è«–

```python
import onnx
from onnx import helper, shape_inference
inferred_model = shape_inference.infer_shapes(model) # å€¤ã« Shape ãŒä»˜ä¸ã•ã‚Œã‚‹
```

### ãƒ¢ãƒ‡ãƒ«ã® Opset version å¤‰æ›

```python
from onnx import version_converter, helper
model = onnx.load("/path/to/model.onnx")
# å¤ã„ opset version â†’ æ–°ã—ã„ opset version ãªã‚‰å¤§æŠµæˆåŠŸã™ã‚‹
new_model = version_converter.convert_version(original_model, TARGET_VERSION)
```

### ãƒ¢ãƒ‡ãƒ«ã«å«ã¾ã‚Œã‚‹ Operator ã®ç¨®é¡ã®åˆ—æŒ™

```python
import onnx
model = onnx.load("/path/to/model.onnx")
ops = set()
for node in model.graph.node:
    ops.add(node.op_type)
print(ops)
```

### ãƒ¢ãƒ‡ãƒ«ã«å«ã¾ã‚Œã‚‹å€¤ã®åˆ—æŒ™

```python
import onnx
model = onnx.load("../altius/models/mobilenetv3.onnx")
value_names = set()
# å…¥åŠ›
for input in model.graph.input:
    value_names.add(input.name)
# å‡ºåŠ›
for output in model.graph.output:
    value_names.add(output.name)
# åˆæœŸå€¤
for init in model.graph.initializer:
    value_names.add(init.name)
# Node ã®å‡ºåŠ›
for node in model.graph.node:
    for output in node.output:
        value_names.add(output)
print(value_names)
```

### ãƒ¢ãƒ‡ãƒ«ã®ã‚°ãƒ©ãƒ•æ§‹é€ ã‚’å˜ç´”åŒ–

ã—ã°ã—ã°ã€ãƒ¢ãƒ‡ãƒ«ã®ã‚°ãƒ©ãƒ•æ§‹é€ ãŒè¤‡é›‘ï¼ˆe.g., ä½¿ã‚ã‚Œã¦ã»ã—ããªã„ operator ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼‰ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ãã®å ´åˆã€[onnx-simplifier](https://github.com/daquexian/onnx-simplifier) ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€å˜ç´”åŒ–ã§ãã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚

```python
import onnx
import onnxsim # pip install onnxsim
model = onnx.load("/path/to/model.onnx")
new_model, ok = onnxsim.simplify(model)
assert ok, "Failed to simplify"
```

### PyTorch ãƒ¢ãƒ‡ãƒ«ã‚’ ONNX ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

[`torch.onnx.export`](https://pytorch.org/docs/stable/onnx_torchscript.html#torch.onnx.export) ã‚’ä½¿ã†ã“ã¨ãŒå¤šã„ã§ã™ã€‚

```python
import torch
import torchvision
model = torchvision.model.mobilenet_v3_large(pretrained=True) # ã©ã‚“ãªãƒ¢ãƒ‡ãƒ«ã§ã‚‚å¤§æŠµã¯å¤§ä¸ˆå¤«
path = "/path/to/out_model.onnx"
torch.onnx.export(
    model,
    torch.randn(1, 3, 224, 224), # shape ãŒæ­£ã—ã‘ã‚Œã°å€¤ã¯é–¢ä¿‚ãªã„
    path,
    opset_version=14 # é©åˆ‡ãª opset version ã‚’è‡ªã‚‰æŒ‡å®š
)
```

### ã¾ã ã‚ã‚Šãã†

TODO...

## `ModelProto` ã®ä½¿ã„ã‚„ã™ã„ãƒ©ãƒƒãƒ‘ãƒ¼

[`OnnxModel`](https://github.com/microsoft/onnxruntime/blob/9dd9461e655088240cc09d3541cbf7f5c6bb91f9/onnxruntime/python/tools/transformers/onnx_model.py#L32) ã®ã‚ˆã†ãªãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç”¨æ„ã™ã‚‹ã“ã¨ã§ã€ã‚°ãƒ©ãƒ•ã®è§£æãŒã—ã‚„ã™ããªã‚Šã¾ã™ã€‚
ã„ãã¤ã‚‚ã‚¹ãƒ‹ãƒšãƒƒãƒˆã‚’ä½œæˆã—ã¦ã€æ•£ã‚‰ã‹ã£ã¦ã„ãã‚ˆã‚Šã¯è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

```python
# ...
model = onnx.load("/path/to/model.onnx")
new_model = OnnxModel(model)

# e.g., ã‚ã‚‹ãƒãƒ¼ãƒ‰ã® childrenï¼ˆãã®ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒãƒ¼ãƒ‰ï¼‰ã‚’çŸ¥ã‚ŠãŸã„
children = new_model.get_children(specific_node)

# e.g., ã‚ã‚‹ãƒãƒ¼ãƒ‰ã«å®šæ•°å…¥åŠ›ãŒã‚ã‚‹ãªã‚‰ãã‚Œã‚’çŸ¥ã‚ŠãŸã„
nth, const_node = new_model.get_constant_input(specific_node)
```
