---
title: "ONNX について"
emoji: "🪨"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["ONNX"]
published: false
---

# はじめに

> **ONNX is an open format built to represent machine learning models.**
>
> ONNX defines a common set of operators -
> the building blocks of machine learning and deep learning models -
> and a common file format to enable AI developers to use models with
> a variety of frameworks, tools, runtimes, and compilers.
>
> *[onnx.ai](https://onnx.ai/) より*

[ONNX](https://github.com/onnx/onnx) とは、機械学習モデルを表現するためのオープンなフォーマット（や周辺のエコシステム）を指します。

この記事では、あまり日本語の資料が見つからない部分、特に **ONNX フォーマットの構造や上手な扱い方**について触れていきます。

なお、必ずしも正確な情報を提供できるわけではないため、間違いなどはコメントしていただけると助かります。

# 便利なリンク集

- https://onnx.ai
    - 公式サイト
    - 各種ドキュメントへ飛ぶためのポータルサイトとしても機能している
- https://github.com/onnx/onnx
    - 公式 GitHub リポジトリ
    - フォーマットの定義や周辺ライブラリ・ツールなどを管理している
- https://github.com/onnx/onnx/blob/main/docs/
    - フォーマットのドキュメント
    - 困ったらこのディレクトリ内を探す
- https://github.com/onnx/onnx/blob/main/docs/IR.md
    - IR (中間表現）のドキュメント
- https://github.com/onnx/onnx/blob/main/docs/Operators.md
    - オペレータのドキュメント（一覧）
- https://github.com/onnx/models
    - ONNX 形式の学習済みモデルが多数置いてあるリポジトリ
    - PyTorch などからエクスポートする他にこういった場所からダウンロードすることもできる
- https://github.com/PINTO0309/PINTO_model_zoo
    - 個人で膨大な数の ONNX 形式モデルを管理されている方のリポジトリ

# ONNX の構造

ONNX フォーマット（以下 ONNX）は、[IR.md](https://github.com/onnx/onnx/blob/main/docs/IR.md) にもあるように、[Protocol Buffers として定義](https://github.com/onnx/onnx/blob/main/onnx/onnx.proto)されています。
つまり、`*.onnx` というファイルを見かけたら、Protocol Buffers としてデシリアライズすれば中身を覗くことができるというわけです。

まずは大まかな構造を把握して、その後に細かい部分を見ていきましょう。

## 全体像

ONNX は以下のような階層構造から成り立っています（いくつか省いている要素があります）。

- Model ([`onnx.ModelProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L348)) - モデル（ファイルのトップレベル要素）
    - Graph ([`onnx.GraphProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L447)) - 計算グラフ
        - Node ([`onnx.NodeProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L204)) - 計算ノード

また、これらの要素に含まれるフィールドとして以下が存在します（個人的に重要だと判断したものを抜粋しています）。

- Tensor ([`onnx.TensorProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L487))
- ValueInfo ([`onnx.ValueInfoProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L187))
- Attribute ([`onnx.AttributeProto`](https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/onnx/onnx-ml.proto#L120))

### Model


> | Name             | Type                | Description                                                                                                                                        |
> | ---              | ---                 | ---                                                                                                                                                |
> | ir_version       | int64               | The ONNX version assumed by the model.                                                                                                             |
> | opset_import     | OperatorSetId       | A collection of operator set identifiers made available to the model. An implementation must support all operators in the set or reject the model. |
> | producer_name    | string              | The name of the tool used to generate the model.                                                                                                   |
> | producer_version | string              | The version of the generating tool.                                                                                                                |
> | domain           | string              | A reverse-DNS name to indicate the model namespace or domain, for example, 'org.onnx'                                                              |
> | model_version    | int64               | The version of the model itself, encoded in an integer.                                                                                            |
> | doc_string       | string              | Human-readable documentation for this model. Markdown is allowed.                                                                                  |
> | **graph**        | **Graph**           | The parameterized graph that is evaluated to execute the model.                                                                                    |
> | metadata_props   | map<string,string>  | Named metadata values; keys should be distinct.                                                                                                    |
> | training_info    | TrainingInfoProto[] | An optional extension that contains information for training.                                                                                      |
> | functions        | FunctionProto[]     | An optional list of functions local to the model.                                                                                                  |
> 
> https://github.com/onnx/onnx/blob/a66b596981156097da5988cf6f9527817e5bcad7/docs/IR.md#models

### Graph

### Node

## Operator versioning

# ONNX の扱い方
