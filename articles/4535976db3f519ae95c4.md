---
title: "Glow ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ’¬"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©"]
published: true
---

ã“ã®è¨˜äº‹ã§ã¯ã€ç§ãŒ [Glow ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©](https://github.com/pytorch/glow) (ä»¥ä¸‹ Glow) ã‚’ãƒ“ãƒ«ãƒ‰ã—ãŸæ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚è¦ã™ã‚‹ã«å‚™å¿˜éŒ²ã§ã™ã€‚

# Glow ã¨ã¯

ä¸–ã®ä¸­ã«ã¯ **DNN ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©**ã¨å‘¼ã°ã‚Œã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãŒå­˜åœ¨ã—ã¾ã™ã€‚DNN ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã¯ã€ãã®åã®é€šã‚Š Deep Neural Network ã‚’å…¥åŠ›ã¨ã—ã¦å—ã‘å–ã‚Šã€æ§˜ã€…ãªï¼ˆãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢éä¾å­˜ãƒ»ä¾å­˜ã®ï¼‰æœ€é©åŒ–ã‚’æ–½ã—ã€ç‰¹å®šãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ (CPU, GPU, DSPãªã©) å‘ã‘ã®ã‚³ãƒ¼ãƒ‰ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚TensorFlow ã‚„ PyTorch ãªã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®èƒŒå¾Œã«ã¯ DNN ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒéš ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã™ã­ã€‚

Glow ã¯ãã‚“ãª DNN ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã®ä¸€ã¤ã§ã™ï¼ˆã‚‚ã¨ã‚‚ã¨ Facebookè£½ã‚‰ã—ã„ï¼‰ã€‚ä»–ã«ã¯ [TVM](https://github.com/apache/tvm) ãªã©ãŒã‚ã‚Šã¾ã™ã€‚

# ãƒ“ãƒ«ãƒ‰

ã•ã£ããã€ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚µãƒ³ãƒ—ãƒ«ãªã©ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

... ã¨è¡ŒããŸã„ã®ã§ã™ãŒã€æ‰‹å…ƒã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹ä¸­ã§æ§˜ã€…ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã—ã¾ã„ã¾ã—ãŸï¼ˆãã‚‚ãã‚‚[ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã™ã‚‹](https://github.com/pytorch/glow/issues/5769)ã€å‡ºæ¥ä¸ŠãŒã£ãŸãƒã‚¤ãƒŠãƒªãŒSEGVã‚’åã„ã¦è½ã¡ã‚‹ã€etc...ï¼‰ã€‚
ãŠãã‚‰ãç§ãŒ Ubuntu 20.04 ã‚’ä½¿ã£ã¦ã„ã‚‹ã›ã„ãªã®ã§ï¼ˆUbuntu 16.04, 18.04 ã§ã—ã‹ãƒ†ã‚¹ãƒˆã•ã‚Œã¦ã„ãªã„ï¼‰ã€ä»¥ä¸‹ã§ã¯ **Docker** ã‚’ä½¿ã£ãŸãƒ“ãƒ«ãƒ‰æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

å…ˆã«å¤§ã¾ã‹ãªæ‰‹é †ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¦ãŠãã¾ã™ã€‚

1. ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãŠã
2. ãŠå¥½ã¿ã§ Dockerfile ã‚’ã„ã˜ã‚‹
3. `docker build` & `docker run`
4. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ

## Dockerfile ã‚’ç”¨æ„ã™ã‚‹

`docker build`ã—ãŸã„ã®ã§ Dockerfile ãŒå¿…è¦ã§ã™ãŒã€å®Ÿã¯ã™ã§ã«ãƒªãƒã‚¸ãƒˆãƒªã«ç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚å¬‰ã—ã„ã§ã™ã­ã€‚

ã¾ãšã¯ã€[ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/pytorch/glow)ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚æ¬¡ã«ã€`./glow/utils/docker/`ã«ç§»å‹•ã—ã¦ README.md ã‚’ç¢ºèªã—ã¾ã™ã€‚
ãã®ã¾ã¾ README.md é€šã‚Šã«å®Ÿè¡Œã™ã‚Œã°ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ï¼ˆã¯ãšãªï¼‰ã®ã§ã™ãŒã€ã“ã®ã¾ã¾ã ã¨ CPU å‘ã‘ãƒ“ãƒ«ãƒ‰ã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚GPU ã‚’ä½¿ã„ãŸã„æ–¹ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

- `./glow/CMakeLists.txt`

  - ```cmake
    ...
    option(GLOW_WITH_OPENCL "Build the OpenCL backend" ON) # OFF ã‹ã‚‰ ON ã«å¤‰æ›´
    ...
    ```

- `./glow/utils/docker/Dockerfile`

  - Docker ä¸Šã§ GPU ã‚’ä½¿ã†ãŸã‚ã®æº–å‚™ã‚’ã—ã¦ãŠã„ã¦ãã ã•ã„

    - [ã“ã®ã‚ãŸã‚Š](https://qiita.com/ksasaki/items/b20a785e1a0f610efa08)ãŒå½¹ã«ç«‹ã¡ãã†

  - ```dockerfile
    FROM nvidia/opencl:devel-ubuntu18.04 # opencl ã‚’ä½¿ã†ãŸã‚
    
    ARG WORKDIR=/root/dev
    
    # Create working folder
    RUN mkdir -p $WORKDIR
    WORKDIR $WORKDIR
    
    # Update and install tools
    RUN apt-get update && \
        apt-get install -y clang clang-8 cmake graphviz libpng-dev \
            libprotobuf-dev llvm-8 llvm-8-dev ninja-build protobuf-compiler wget \
            opencl-headers libgoogle-glog-dev libboost-all-dev \
            libdouble-conversion-dev libevent-dev libssl-dev libgflags-dev \
            libjemalloc-dev libpthread-stubs0-dev \
            # Additional dependencies
            git python-numpy && \
        # Delete outdated llvm to avoid conflicts
        apt-get autoremove -y llvm-6.0 && \
        apt-get clean && \
        rm -rf /var/lib/apt/lists/*
    
    # Point clang to llvm-8 version
    RUN update-alternatives --install /usr/bin/clang clang \
            /usr/lib/llvm-8/bin/clang 50 && \
        update-alternatives --install /usr/bin/clang++ clang++ \
            /usr/lib/llvm-8/bin/clang++ 50
    
    # Point default C/C++ compiler to clang
    RUN update-alternatives --set cc /usr/bin/clang && \
        update-alternatives --set c++ /usr/bin/clang++
    
    # Install fmt
    RUN git clone https://github.com/fmtlib/fmt && \
        mkdir fmt/build && \
        cd fmt/build && \
        cmake .. && make -j && \ # ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰
        make install
    
    # Clean up
    RUN rm -rf fmt
    ```

## Docker ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹

ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```sh
pwd
# /PATH/TO/glow/utils/docker
docker build --cpuset-cpus="0-7" -t pytorch/glow . # é©åˆ‡ãªCPUã‚³ã‚¢ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
docker run --cpuset-cpus="0-7" --gpus all -it -v /PATH/TO/glow:/root/dev pytorch/glow
# ä»¥ä¸‹ Docker å†…ï¼›Dockerfile ã«è¨˜è¿°ã—ã¦ã‚‚ã„ã„ã‹ã‚‚ï¼Ÿ
mkdir build_Release
cd build_Release
cmake -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=/usr/lib/llvm-8 ../ # CMAKE_BUILD_TYPE=Debug/Release
ninja all
```

ã—ã°ã‚‰ãå¾…ã£ãŸã‚‰ãƒ“ãƒ«ãƒ‰çµ‚äº†ã§ã™ã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚

# MNIST 

ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ MNIST ã®å­¦ç¿’ï¼†æ¨è«–ã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚

```sh
# Docker å†…
pwd
# /root/dev/build_Release
python ../utils/download_datasets_and_models.py -d mnist
./bin/mnist --backend $BACKEND # $BACKEND ã¯ Interpreter,CPU,OpenCL ã®ã©ã‚Œã‹
```

`./bin/mnist`ã§å­¦ç¿’ãŒå§‹ã¾ã‚Šã€ã¡ã‚‡ã£ã¨ã—ãŸæ¨è«–çµæœãŒã‚¢ã‚¹ã‚­ãƒ¼ã‚¢ãƒ¼ãƒˆã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
GPUã‚’ä½¿ãˆã‚‹æ–¹ã¯OpenCLã‚’æŒ‡å®šã™ã‚‹ã¨ã€CPUã‚ˆã‚Šã‚‚é«˜é€Ÿã«å­¦ç¿’ãŒé€²ã‚€ã“ã¨ã‚’ç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚ï¼ˆ`nvidia-smi`ã§GPU-UtilãŒå¸¸ã«90%ä»¥ä¸Šã§ã—ãŸï¼‰

MNIST ä»¥å¤–ã®ã‚µãƒ³ãƒ—ãƒ«ã‚‚ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€è©³ã—ãã¯ãƒªãƒã‚¸ãƒˆãƒªã® README.md ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
