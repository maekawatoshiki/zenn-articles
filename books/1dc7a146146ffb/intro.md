---
title: "はじめに"
---

# この記事は何？

[LLVM](https://llvm.org/) には当然ながらレジスタアロケータが実装されています。
LLVMのレジスタアロケータは初見ではなかなか動作が追いにくいため、備忘録を兼ねて記事を書くことにしました。

# LLVMのレジスタアロケータの特徴

コンパイラの教科書を読んでいると、レジスタアロケーションのためにグラフ彩色問題を解いていることが多いです。これ自体は特におかしなことではありません。

一方、LLVMのレジスタアロケータはグラフ彩色問題を解きません。理由は様々ありますが、以下に要約されます。[^1]
- グラフを構築するのは時間がかかる
- グラフ彩色よりも、スピルのためのコードをどう配置するかが重要
- エイリアスや重なり合ったレジスタクラス（e.g. `eax`と`rax`）をうまく扱わないといけない
- グラフ彩色よりも、（アロケータを）柔軟にいじれることが重要

LLVM には `Basic`, `Fast`, `Greedy`, `PBQP` の4種類のアロケータが実装されており、特徴は以下の通りです。

- `Basic`: レジスタアロケータとしての最小限の実装
- `Fast`: 基本ブロック単位でレジスタを割り当てる（ので速い）
- `Greedy`: 複雑なレジスタアロケーションを行う（ので最適化ビルド向け）
- `PBQP`: Partitioned Boolean Quadratic Programming に基づくレジスタアロケーションを行う（この記事ではあまり触れません）

この記事では、`Basic` と `Greedy` に特に焦点をあてて解説します。

[^1]: [Register Allocation in LLVM 3.0](https://llvm.org/devmtg/2011-11/Olesen_RegisterAllocation.pdf), p.7
